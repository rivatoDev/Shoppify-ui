<div class="meli-card">
  
  @if (showDate) {
    <div class="card-date-header">
      {{ shipment?.startDate ? (shipment?.endDate ? (shipment?.endDate | date:'d/M') : (shipment?.startDate | date:'d/M')) : (purchase.dateTime | date:"d 'de' MMMM") }}
    </div>
  }

  <div class="card-body">

    <div class="product-image-col" [class.mosaic]="purchase.detailTransactions.length > 1"
      (click)="purchase.detailTransactions.length > 1 ? viewPurchaseDetails() : gotoDetailsProduct(purchase.detailTransactions[0].product?.id)">

      @if (purchase.detailTransactions && purchase.detailTransactions.length > 0) {

      @if (purchase.detailTransactions.length === 1) {
      <img [src]="purchase.detailTransactions[0].product?.imgURL || 'assets/no-image.png'" alt="Producto">
      }

      @else {
      @for (item of purchase.detailTransactions.slice(0, 4); track item.id) {
      <div class="mini-img-container">
        <img [src]="item.product?.imgURL || 'assets/no-image.png'" alt="Mini producto">
      </div>
      }
      }

      } @else {
      <div class="no-image-placeholder">ðŸ“·</div>
      }
    </div>

    <div class="info-col">
      <div class="status-row">
        <span class="status-text" [ngClass]="getStatusColor()">
          {{ getStatusText() }}
        </span>

        @if (getMainStatusMessage() === 'DELIVERED') {
        <span class="arrival-text">LlegÃ³ el {{ shipment?.endDate | date:'d/M' }}</span>
        } @else if (getMainStatusMessage()) {
        <span class="main-status-msg">{{ getMainStatusMessage() }}</span>
        }
      </div>

      <h3 class="product-title" (click)="gotoDetailsProduct(purchase.detailTransactions[0].product?.id)">
        {{ purchase.detailTransactions[0].product?.name }}
        @if (purchase.detailTransactions.length > 1) {
        <span class="more-count">+ {{ purchase.detailTransactions.length - 1 }} productos mÃ¡s</span>
        }
      </h3>

      <p class="units-text">
        {{ getTotalUnits() }} unidad{{ getTotalUnits() > 1 ? 'es' : '' }}       
      </p>
      @if (showTotal) {
      <p class="units-text">
        Total: {{ purchase.total | currency:'ARS':'symbol':'1.0-2' }}
      </p>
      }

      @if (isAdmin && purchase.userId) {
      <div class="admin-data">
        <span class="buyer-label">User ID: {{ purchase.userId }} | Compra #{{ purchase.id }}</span>
        <button class="toggle-client" (click)="toggleClientInfo(purchase.userId)">
          {{ clientsExpanded().has(purchase.userId!) ? 'Ocultar' : 'Ver cliente' }}
        </button>
      </div>
      @if (clientsExpanded().has(purchase.userId!)) {
      <div class="client-mini-details">
        {{ clientsCache().get(purchase.userId!)?.firstName }} {{ clientsCache().get(purchase.userId!)?.lastName }} - {{
        clientsCache().get(purchase.userId!)?.email }}
      </div>
      }
      }
    </div>

    <div class="actions-col">
      <button class="btn-primary" (click)="viewPurchaseDetails()">Ver compra</button>

      @if (canContinuePayment()) {
      <button class="btn-primary" style="background-color: #009ee3; border-color: #009ee3;"
        (click)="continuePayment()">Continuar pago</button>
      }

      @if (showRebuy && purchase.detailTransactions.length === 1 && purchase.paymentStatus !== 'PENDING') {
   <button (click)="gotoDetailsProduct(purchase.detailTransactions[0].product?.id)"class="btn-secondary">Volver a comprar</button>
      }

    </div>

  </div>
</div>
