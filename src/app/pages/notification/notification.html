<div class="notification-manager">
  
  <header class="page-header">
    <div class="header-content">
      <h1>Crear Notificaci√≥n</h1>
      <p>Env√≠a alertas y mensajes a tus usuarios.</p>
    </div>
    <button class="btn-back" (click)="goBack()">Volver al Admin</button>
  </header>

  <main class="content-grid">
    
    <section class="list-section">
      <div class="section-local-header">
        <h2>Recientes</h2>
        <button class="btn-add" (click)="createItem()" [class.active-add]="!selectedItem">
          + Nueva
        </button>
      </div>

      <div class="notification-list">
        @if (notifications.length === 0) {
          <div class="empty-state">
            <p>No hay notificaciones recientes.</p>
          </div>
        }

        @for (item of notifications; track item.id) {
          <div class="notification-card" 
               (click)="onPreviewSelect(item)"
               [class.selected]="selectedItem?.id === item.id">
            
            <div class="card-thumb" style="display:flex;align-items:center;justify-content:center;font-size:20px;">
               @if(item.type === 'GLOBAL') { üåç } @else { üë§ }
            </div>
            
            <div class="card-info">
              <span class="card-title">
                {{ item.title }}
                @switch (getStatus(item)) {
                  @case ('active') { <span class="badge-status status-active">Activa</span> }
                  @case ('scheduled') { <span class="badge-status status-scheduled">Programada</span> }
                  @case ('expired') { <span class="badge-status status-expired">Expirada</span> }
                }
              </span>
              <span class="card-link" style="font-size:11px">{{ item.publishAt | date:'dd/MM/yyyy' }}</span>
              <span class="card-link" style="color:#aaa">{{ item.message | slice:0:30 }}...</span>
            </div>

            <div class="card-arrow">
              <span class="material-icons">></span>
            </div>
          </div>
        }
      </div>
    </section>

    <!-- Right Column: Editor Form -->
    <section class="editor-section">
      <div class="editor-card">
        <div class="editor-header">
          @if (selectedItem) {
            <h3>Estas editando "{{selectedItem.title }}"</h3>
          } @else {
            <h3>Nueva notificaci√≥n</h3>
          }
          
        </div>

        <form [formGroup]="fg" (ngSubmit)="onSubmit()" class="editor-form">
          
          <div class="form-type-badge">
            <span class="badge-global">Esta notificacion se enviara a todos los usuarios</span>
          </div>

          <div class="form-group">
            <label for="title">T√≠tulo</label>
            <input type="text" id="title" formControlName="title" placeholder="Ej: ¬°Oferta Flash!">
            <div class="error-msg" *ngIf="showErrors('title')">
              Requerido (4-80 caracteres).
            </div>
          </div>

          <div class="form-group">
            <label for="message">Mensaje</label>
            <textarea id="message" formControlName="message" rows="3" placeholder="Escribe el contenido de la alerta..."></textarea>
            <div class="error-msg" *ngIf="showErrors('message')">
              Requerido.
            </div>
          </div>

          <!-- Delivery Mode -->
          <div class="form-group">
            <label>Cu√°ndo enviar</label>
            <div class="mode-toggles" style="display:flex; gap:16px; margin-bottom:8px;">
              <label class="radio-label" style="display:flex; gap:8px; align-items:center; cursor:pointer;">
                <input type="radio" formControlName="deliveryMode" value="immediate">
                <span>‚ö° Enviar Ahora</span>
              </label>
              <label class="radio-label" style="display:flex; gap:8px; align-items:center; cursor:pointer;">
                <input type="radio" formControlName="deliveryMode" value="scheduled">
                <span>üìÖ Programar</span>
              </label>
            </div>
            
            <!-- Immediate Info -->
            @if (fg.get('deliveryMode')?.value === 'immediate') {
              <div class="info-box" style="background:#e3edfb; color:#3483fa; padding:12px; border-radius:8px; font-size:13px; margin-bottom: 16px;">
                La notificaci√≥n se enviar√° inmediatamente a todos los usuarios.
              </div>

              <div class="form-group">
                <label>Vencimiento (Opcional)</label>
                <div style="display: flex; gap: 16px;">
                  <mat-form-field appearance="outline" style="flex: 1;">
                    <mat-label></mat-label>
                    <input matInput [matDatepicker]="pickerImmediate" formControlName="immediateExpireDate">
                    <mat-datepicker-toggle matIconSuffix [for]="pickerImmediate"></mat-datepicker-toggle>
                    <mat-datepicker #pickerImmediate></mat-datepicker>
                  </mat-form-field>
                  
                  <div class="time-field" style="width: 120px;">
                    <input type="time" formControlName="endTime" style="height: 56px; margin-top:0;">
                  </div>
                </div>
                
                <!-- Expiration Warning -->
                @if (!fg.get('immediateExpireDate')?.value) {
                  <div class="warning-box">
                    Sin vencimiento: La notificaci√≥n permanecer√° activa indefinidamente.
                  </div>
                }
              </div>
            }
          </div>

          <!-- Scheduling -->
          @if (fg.get('deliveryMode')?.value === 'scheduled') {
            <div class="form-group">
              <label>Programar fecha</label>
              
              <!-- Material Datepicker -->
              <mat-form-field appearance="outline" class="w-100">
              
                <mat-date-range-input [rangePicker]="picker" [min]="minDate">
                  <input matStartDate formControlName="publishStart" placeholder="Inicio">
                  <input matEndDate formControlName="publishEnd" placeholder="Fin">
                </mat-date-range-input>
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-date-range-picker #picker></mat-date-range-picker>
              </mat-form-field>

              <div class="time-grid">
                <div class="time-field">
                  <label for="sTime">Hora Inicio</label>
                  <input type="time" id="sTime" formControlName="startTime">
                </div>
                <div class="time-field">
                  <label for="eTime">Hora Fin</label>
                  <input type="time" id="eTime" formControlName="endTime">
                </div>
              </div>
            </div>
          }

          <div class="form-actions">
            <div class="left-actions">
               @if (selectedItem) {
                <button type="button" class="btn-delete" (click)="onDelete()">Eliminar</button>
               }
            </div> 
            <div class="right-actions">
              <button type="button" class="btn-cancel" (click)="resetCurrent()">Limpiar</button>
              <button type="submit" class="btn-save" [disabled]="fg.invalid">
                {{ selectedItem ? 'Guardar Cambios' : 'Enviar Notificaci√≥n' }}
              </button>
            </div>
          </div>

        </form>
      </div>
    </section>

  </main>
</div>


